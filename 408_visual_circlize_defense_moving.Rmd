---
title: "Defense Moving"
author: "Haotian Zheng"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(circlize)
```

```{r}
# Load required libraries
library(circlize)

# Function to create chord diagram
create_chord_diagram <- function(input_file, output_png, output_pdf) {
  # Read data
  dkb <- read.csv(input_file, row.names = 1)
  dkb_matrix <- as.matrix(dkb)
  
  # Set colors
  color_row = c("SoF" = "#d0cab7", "Wad" = "#6566aa",
                "PD6" = "#c6a4c5", "RM" = "#c6f0ec",
                "AbiE" = "#8fced1", "AbiD" = "#4d9793",
                "Cas" = "#f7ded5", "Zor" = "#f07e40",
                "CBA" = "#dc5772", "Sep" = "#beccc5")
  color_col = c("Ps" = "#BF7EA2", "Ba" = "#BF7EA2",
                "Bc" = "#BF7EA2", "Ca" = "#BF7EA2",
                "Ac" = "#BF7EA2", "My" = "#BF7EA2",
                "Ve" = "#BF7EA2", "Th" = "#BF7EA2",
                "Ph" = "#0B2E55", "Pm" = "#9cb3ad")
  state_col2 = c(color_row, color_col)
  names(state_col2) = c(rownames(dkb_matrix), colnames(dkb_matrix))
  
  # Create chord diagram
  circos.clear()
  # Increase margin and adjust parameters to add more space
  circos.par(cell.padding = c(0.02, 0.02, 0.02, 0.02),
             track.margin = c(0.01, 0.01),
             start.degree = 0,
             gap.degree = 5,
             points.overflow.warning = FALSE)
  
  cdm_res = chordDiagram(dkb_matrix, grid.col = state_col2,
      directional = TRUE, annotationTrack = "grid", 
      big.gap = 10, small.gap = 1, # Slightly reduce gaps between sectors
      preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(dkb_matrix))))),
      link.target.prop = FALSE)
  
  circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
      sector.index = get.cell.meta.data("sector.index")
      xlim = get.cell.meta.data("xlim")
      ylim = get.cell.meta.data("ylim")
      circos.text(mean(xlim), ylim[1] + 0.1, sector.index, # Adjust label position
                  facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5), cex = 0.8)
  }, bg.border = NA)
  
  # Save as PNG
  png(output_png, width = 1500, height = 1500, res = 150) # Increase image size
  par(mar = c(20, 20, 20, 20)) # Add margin to the plot
  circos.clear()
  cdm_res = chordDiagram(dkb_matrix, grid.col = state_col2,
      directional = TRUE, annotationTrack = "grid", 
      big.gap = 15, small.gap = 2, # Increase gaps between sectors
      preAllocateTracks = list(track.height = 0.2),
      link.target.prop = FALSE)
  circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
      sector.index = get.cell.meta.data("sector.index")
      xlim = get.cell.meta.data("xlim")
      ylim = get.cell.meta.data("ylim")
      circos.text(mean(xlim), ylim[1] + 0.2, sector.index, # Move labels further out
                  facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
  }, bg.border = NA)
  dev.off()
  
  # Save as PDF
  pdf(output_pdf, width = 12, height = 12) # Increase PDF size
  par(mar = c(10, 10, 10, 10)) # Add margin to the plot
  circos.clear()
  cdm_res = chordDiagram(dkb_matrix, grid.col = state_col2,
      directional = TRUE, annotationTrack = "grid", 
      big.gap = 15, small.gap = 2, # Increase gaps between sectors
      preAllocateTracks = list(track.height = 0.2),
      link.target.prop = FALSE)
  circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
      sector.index = get.cell.meta.data("sector.index")
      xlim = get.cell.meta.data("xlim")
      ylim = get.cell.meta.data("ylim")
      circos.text(mean(xlim), ylim[1] + 0.2, sector.index, # Move labels further out
                  facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5), cex = 2.5, font = 2)
  }, bg.border = NA)
  dev.off()
}

# Function to process all files in a directory
process_directory <- function(input_dir, output_dir) {
  # Create output directory if it doesn't exist
  dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
  
  # Get list of CSV files in input directory
  csv_files <- list.files(input_dir, pattern = "\\.csv$", full.names = TRUE)
  
  # Process each file
  for (input_file in csv_files) {
    file_name <- tools::file_path_sans_ext(basename(input_file))
    output_png <- file.path(output_dir, paste0(file_name, ".png"))
    output_pdf <- file.path(output_dir, paste0(file_name, ".pdf"))
    
    create_chord_diagram(input_file, output_png, output_pdf)
    
    cat("Processed:", input_file, "\n")
    cat("Output PNG:", output_png, "\n")
    cat("Output PDF:", output_pdf, "\n\n")
  }
}

# Set input and output directories
input_dir <- "Collect/08_Circular/Final_GCGB_top10"
output_dir <- "Results/08_Circular/GCGB_top10_new"

# Process all files in the input directory
process_directory(input_dir, output_dir)

print("All chord diagrams have been generated and saved in the output directory.")
```

