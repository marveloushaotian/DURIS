---
title: "visual_heatmap_compare"
author: "Haotian Zheng"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(ComplexHeatmap)
library(circlize)
library(grid)
library(tidyverse)
```

```{r}
# Set fixed parameters
chromosome_file <- "Collect/01_Defense/03_DF_TPM_Matrix/DefenseSubType/processed_chromosome_to_metagenome_abundance.csv"  # Replace with actual path
plasmid_file <- "Collect/01_Defense/03_DF_TPM_Matrix/DefenseSubType/processed_crplasmid_to_metagenome_abundance.csv"  # Replace with actual path
group_file <- "Collect/00_Metadata/Sample_Group.csv"  # Replace with actual path to group information
output_file <- "Results/03_DF_Compare/Heatmap/Compare_subtype_cr_plasmid_heatmap.pdf"  # Replace with desired output path
figure_width <- 20   # in cm
figure_height <- 40  # in cm
fontsize <- 15

# Load data
load_data <- function(file_path) {
  data <- read.csv(file_path, row.names = 1)
  return(data)
}

# Load group information
load_group_info <- function(file_path) {
  group_info <- read.csv(file_path)
  group_info$Location <- factor(group_info$Location, levels = c("HP", "RS", "MS", "BTP"))
  group_info$Country <- factor(group_info$Country, levels = c("DK", "SP", "UK"))
  group_info <- group_info[order(group_info$Location, group_info$Country), ]
  return(group_info)
}

# Create custom colormap
create_custom_colormap <- function() {
  colors <- c("#aa7aa7", "#c88b9c", "#d4a29a", "#d6bca7", "#d8d4c1",
              "#cdd2c2", "#c4cfc3", "#beccc5", "#9cb3ad", "#7a9b99",
              "#598287", "#3a6a77")
  return(colorRamp2(seq(-6, 6, length.out = length(colors)), colors))
}

# Define custom colors for Location and Country
location_colors <- c("HP" = "#c6a4c5", "RS" = "#a3cbd6", "MS" = "#d1b49a", "BTP" = "#ffc7c9")
country_colors <- c("DK" = "#cd6073", "SP" = "#e1834e", "UK" = "#434d91")

# Generate heatmap
generate_heatmap <- function(chromosome_data, plasmid_data, group_info, output_path, figure_width, figure_height, fontsize) {
  common_types <- intersect(rownames(chromosome_data), rownames(plasmid_data))
  chromosome_aligned <- chromosome_data[common_types, ]
  plasmid_aligned <- plasmid_data[common_types, ]
  
  fold_change <- log2((plasmid_aligned + 1) / (chromosome_aligned + 1))
  mean_fold_change <- rowMeans(fold_change)
  sorted_types <- names(sort(mean_fold_change))  # Sort by mean fold change
  fold_change <- fold_change[sorted_types, ]
  
  # Transpose the fold_change matrix
  fold_change <- t(fold_change)
  
  # Order rows based on group_info
  fold_change <- fold_change[match(group_info$Sample, rownames(fold_change)), ]
  
  custom_cmap <- create_custom_colormap()
  
  # Create row annotation
  row_anno <- rowAnnotation(
    Location = group_info$Location,
    Country = group_info$Country,
    col = list(
      Location = location_colors,
      Country = country_colors
    ),
    show_annotation_name = FALSE,  # Remove annotation names
    annotation_legend_param = list(
      title_gp = gpar(fontsize = fontsize),
      labels_gp = gpar(fontsize = fontsize)
    )
  )
  
  ht <- Heatmap(as.matrix(fold_change),
                name = "Abundance(log)\nChromosome(Purple)\nPlasmid(Blue)",
                col = custom_cmap,
                show_row_names = TRUE,
                show_column_names = TRUE,
                cluster_rows = FALSE,
                cluster_columns = FALSE,
                row_names_gp = gpar(fontsize = fontsize),
                column_names_gp = gpar(fontsize = fontsize, rot = 90),
                left_annotation = row_anno,
                row_split = group_info$Location,
                row_gap = unit(2, "mm"),
                row_title = NULL,  # Add this line to remove row titles
                heatmap_legend_param = list(
                  title_gp = gpar(fontsize = fontsize),
                  labels_gp = gpar(fontsize = fontsize)
                ))
  
  pdf(output_path, width = figure_width / 2.54, height = figure_height / 2.54)
  draw(ht)
  dev.off()
  
  print(paste("Heatmap saved successfully to", output_path))
}

# Main function
main <- function() {
  chromosome_data <- load_data(chromosome_file)
  plasmid_data <- load_data(plasmid_file)
  group_info <- load_group_info(group_file)
  
  generate_heatmap(chromosome_data, plasmid_data, group_info, output_file, figure_width, figure_height, fontsize)
}

# Run the main function
main()
```

