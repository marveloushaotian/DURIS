---
title: "Overview"
author: "Haotian Zheng"
date: "2023-10-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
# Load necessary libraries
library(tidyverse)
library(readxl)

```

```{r}
# Libraries
library(dplyr)
library(ggplot2)
library(readxl)

# Step 1: Data Import
metadata_path <- "../Results/00.Get_Data/Metadata.xlsx"
defense_path <- "../Results/00.Get_Data/ALL_extracted_defense.csv"

metadata_df <- read_excel(metadata_path)
defense_df <- read.csv(defense_path)

defense_df$Sample <- gsub("-", "_", defense_df$Sample)

# Step 2: Rename columns
UniName <- read.delim("../Results/00.Get_Data/Defense_system_name_list.txt", header = TRUE, check.names = FALSE)
UniName_PADLOC <- UniName[,c("Unified Name","Unified Subtype Name","PADLOC Subtype Name")]
colnames(UniName_PADLOC) <- c("Unified_Name", "Unified_Subtype_Name", "SubType")

# Filter out NA and empty strings in SubType
UniName_PADLOC <- UniName_PADLOC %>% filter(!is.na(SubType) & SubType != "")

# Merge defense_df with UniName_PADLOC on 'system' and 'SubType'
defense_df <- left_join(defense_df, UniName_PADLOC, by = c("system" = "SubType"))

# Step 3: Data Merging
merged_df <- merge(metadata_df, defense_df, by = "Sample")

# Step 4: Data Analysis Function
count_data <- function(grouping_var) {
  grouped_df <- merged_df %>%
    group_by(!!sym(grouping_var), Unified_Name) %>%
    summarise(Counts = n())
  return(grouped_df)
}

# Step 5: Data Visualization Function
plot_data <- function(grouping_var, title) {
  grouped_df <- count_data(grouping_var)
  ggplot() +
    geom_bar(data = grouped_df, aes_string(x = grouping_var, y = 'Counts', fill = 'Unified_Name'), stat = "identity", position = "dodge") +
    labs(title = title, x = grouping_var, y = "Counts") +
    theme_minimal() +
    theme(text = element_text(color = "#324f5e"), plot.title = element_text(color = "#e97952"))
}

# Step 6: Generating and Saving Plots
plot_names <- c('Season', 'Country', 'Day', 'Location', 'LocGroup1', 'LocGroup2')

for (i in seq_along(plot_names)) {
  p <- plot_data(plot_names[i], paste("Defense System Distribution by", plot_names[i]))
  print(p)
  ggsave(
    filename = paste0("../Results/01.Overview/Defense_System_Distribution_by_", plot_names[i], ".pdf"),
    plot = p,
    width = 10,
    height = 10,
    dpi = 300
  )
}
```

