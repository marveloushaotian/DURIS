---
title: "Overview"
author: "Haotian Zheng"
date: "2023-10-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
# Load necessary libraries
library(tidyverse)
library(readxl)
```



```{r}
# Step 1: Data Import
metadata_path <- "../Data/Metadata.xlsx"
defense_path <- "../Data/filtered_all_defense_transformed.csv"

metadata_df <- read_excel(metadata_path)
defense_df <- read.csv(defense_path)

defense_df$Sample <- gsub("-", "_", defense_df$Sample)

# Step 2: Data Merging
merged_df <- merge(metadata_df, defense_df, by = "Sample")

# Step 3: Data Analysis

# Grouping by 'Season-Country-Day', 'Country', and 'system'

grouped_df <- merged_df %>%
  group_by(`Season-Country-Day`, Country, Season, system) %>%
  summarise(Counts = n(), Unique_Samples = n_distinct(Sample))

# Count unique samples for each 'Season-Country-Day', 'Country', and 'Season' group
grouped_by_scd <- merged_df %>% group_by(`Season-Country-Day`) %>% summarise(Samples_in_SCD = n_distinct(Sample))
grouped_by_country <- merged_df %>% group_by(Country) %>% summarise(Samples_in_Country = n_distinct(Sample))
grouped_by_season <- merged_df %>% group_by(Season) %>% summarise(Samples_in_Season = n_distinct(Sample))

# Step 4: Data Visualization

p_day <- ggplot() +
  geom_bar(data = grouped_df, aes(x = `Season-Country-Day`, y = Counts, fill = system), stat = "identity", position = "dodge") +
  geom_text(data = grouped_df, aes(x = `Season-Country-Day`, y = Counts, label = Unique_Samples), vjust = 1.6, color = "black", position = position_dodge(0.9), size = 3.5) +
  geom_label(data = grouped_by_scd, aes(x = `Season-Country-Day`, y = Inf, label = Samples_in_SCD), vjust = 1, hjust = 1) +
  labs(title = "Defense System Distribution by Season-Country-Day",
       x = "Season-Country-Day",
       y = "Counts") +
  theme_minimal()

print(p_day)

p_country <- ggplot() +
  geom_bar(data = grouped_df, aes(x = Country, y = Counts, fill = system), stat = "identity", position = "dodge") +
  geom_text(data = grouped_df, aes(x = Country, y = Counts, label = Unique_Samples), vjust = 1.6, color = "black", position = position_dodge(0.9), size = 3.5) +
  geom_label(data = grouped_by_country, aes(x = Country, y = Inf, label = Samples_in_Country), vjust = 1, hjust = 1) +
  labs(title = "Defense System Distribution by Country",
       x = "Country",
       y = "Counts") +
  theme_minimal()

print(p_country)

# 对于 'Season' 分布
p_season <- ggplot() +
  geom_bar(data = grouped_df, aes(x = Season, y = Counts, fill = system), stat = "identity", position = "dodge") +
  geom_text(data = grouped_df, aes(x = Season, y = Counts, label = Unique_Samples), vjust = 1.6, color = "black", position = position_dodge(0.9), size = 3.5) +
  geom_label(data = grouped_by_season, aes(x = Season, y = Inf, label = Samples_in_Season), vjust = 1, hjust = 1) +
  labs(title = "Defense System Distribution by Season",
       x = "Season",
       y = "Counts") +
  theme_minimal()

print(p_season)

# ggsave(filename = "test.png", plot = p, width = 5, height = 5, dpi = 300)

```

