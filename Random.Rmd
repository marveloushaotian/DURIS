---
title: "Random"
author: "Haotian Zheng"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load required libraries
library(tidyverse)
library(readr)

# Read the data
data <- read_tsv("Collect/01_Defense/02_All_processed/All_defense_info_gcgb_sample.txt")

# Data preprocessing
plot_data <- data %>%
  filter(str_starts(Contig_Group, "MG")) %>%  # Filter for Contig_Group starting with "MG"
  group_by(Country, Location_BAF, Contig_Classification) %>%
  summarise(mean_GCGB = mean(GCGB, na.rm = TRUE)) %>%  # Changed back to mean
  group_by(Country, Location_BAF) %>%
  mutate(percentage = mean_GCGB / sum(mean_GCGB) * 100) %>%
  arrange(percentage) %>%  # Sort within each group (ascending order)
  mutate(Contig_Classification = factor(Contig_Classification, levels = unique(Contig_Classification))) %>%
  ungroup() %>%
  mutate(Location_BAF = factor(Location_BAF, levels = c("AF", "BF")))  # Reverse the order of Location_BAF

# Get unique Contig_Classification values for color mapping
unique_classifications <- unique(plot_data$Contig_Classification)

# Create a named vector for custom colors
# Replace these with your preferred colors
custom_colors <- setNames(
  c("#E41A1C", "#377EB8", "#4DAF4A"),
  unique_classifications
)

# Print color mapping for verification
print(custom_colors)

# Create the plot
ggplot(plot_data, aes(x = Location_BAF, y = percentage, fill = Contig_Classification)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_stack(vjust = 0.5), 
            size = 3, color = "white") +
  facet_wrap(~ Country, scales = "free_y") +
  labs(y = "Abundance Percentage",
       fill = "Classification") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 0, hjust = 0.5),
        legend.position = "right",
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1), expand = c(0, 0)) +
  scale_fill_manual(values = custom_colors)  # Use custom colors

# Save the plot
ggsave("corrected_color_stacked_percentage_bar_chart.png", width = 14, height = 10, dpi = 300)

# Print unique Contig_Classification values for verification
print(unique_classifications)
```

```{r}
# Load required libraries
library(tidyverse)
library(readr)

# Read the data
data <- read_tsv("Collect/01_Defense/02_All_processed/All_defense_info_gcgb_sample.txt")

# Data preprocessing
plot_data <- data %>%
  filter(str_starts(Contig_Group, "MG")) %>%  # Filter for Contig_Group starting with "MG"
  group_by(Country, Location_BAF, Contig_Classification) %>%
  summarise(mean_GCGB = mean(GCGB, na.rm = TRUE)) %>%  # Calculate mean GCGB
  ungroup() %>%
  arrange(mean_GCGB) %>%  # Sort within each group (ascending order)
  mutate(Contig_Classification = factor(Contig_Classification, levels = unique(Contig_Classification))) %>%
  mutate(Location_BAF = factor(Location_BAF, levels = c("AF", "BF")))  # Reverse the order of Location_BAF

# Get unique Contig_Classification values for color mapping
unique_classifications <- unique(plot_data$Contig_Classification)

# Create a named vector for custom colors
custom_colors <- setNames(
  c("#E41A1C", "#377EB8", "#4DAF4A"),
  unique_classifications
)

# Print color mapping for verification
print(custom_colors)

# Create the plot
ggplot(plot_data, aes(x = Location_BAF, y = mean_GCGB, fill = Contig_Classification)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = round(mean_GCGB, 1)), 
            position = position_stack(vjust = 0.5), 
            size = 3, color = "white") +
  facet_wrap(~ Country, scales = "free_y") +
  labs(y = "Defense Abundance per Sample",
       fill = "Classification") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 0, hjust = 0.5),
        legend.position = "right",
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = custom_colors)  # Use custom colors

# Save the plot
ggsave("corrected_color_stacked_mean_bar_chart.png", width = 14, height = 10, dpi = 300)

# Print unique Contig_Classification values for verification
print(unique_classifications)

```

